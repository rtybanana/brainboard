<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <title>BrainBoard</title>
  <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
  <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
  <link rel="stylesheet" href="styles/core.css" />

  <script src="//polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>
  <script src="https://unpkg.com/http-vue-loader"></script>

  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/sankey.js"></script>
  <script src="https://code.highcharts.com/modules/dependency-wheel.js"></script>
  <script src="https://code.highcharts.com/modules/series-label.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/highcharts-vue@1.3.5/dist/highcharts-vue.min.js" integrity="sha256-hKFRfQ9p+dJzRUsmFn8f7lv3t44kUbyKGRdU+1FZ4DM=" crossorigin="anonymous"></script>

  <script src="scripts/core.js"></script>
  <script src="scripts/mixins.js"></script>
</head>

<body>

  <div id="app" v-cloak>
    <b-navbar type="dark" variant="danger" sticky>
      <b-navbar-brand href="#">BrainBoard</b-navbar-brand>
      <b-navbar-nav>
        <b-nav-item-dropdown text="Parameters">
          <b-dropdown-form form-class="nav-params">
            <b-form-group label="Connectivity Threshold" label-for="threshold">
              <b-input-group size="sm">
                <b-form-input id="threshold" size="sm" v-model="threshold" type="range" min="1" max="1000"></b-form-input>
                <b-input-group-append>
                  <b-input-group-text>
                    {{(computedThreshold * 100).toFixed(1)}}%
                  </b-input-group-text>
                </b-input-group-append>
              </b-input-group>
            </b-form-group>
          </b-dropdown-form>
        </b-nav-item-dropdown>
      </b-navbar-nav>
      

      <b-navbar-nav class="ml-auto">
        <label class="mb-0 nav-link clickable" class="">
          Upload Data
          <input type="file" style="position: fixed; top: -100em">
        </label>
        <b-nav-item-dropdown text="Examples" right>
          <b-dropdown-item @click="load('data/simple.json')">Example #1 (Simple)</b-dropdown-item>
          <b-dropdown-item @click="load('data/harvard.json')">Example #2 (Harvard Oxford)</b-dropdown-item>
          <b-dropdown-item href="#">Example #3</b-dropdown-item>
        </b-nav-item-dropdown>
      </b-navbar-nav>
    </b-navbar>

    <div class="row no-gutters">
      <div class="col-5 col-lg-3" style="z-index: 10;">
        <div>
          <div class="px-1 pb-1" style="position:absolute; background-color: black; color: white;">Orthographic Projection</div>
          <ortho :regions="regions" :connections="connections" :region-names="region_names"></ortho>
        </div>
      </div>
      <div class="col-7 col-lg-4">
        <div class="row no-gutters">
          <div class="col-12" style="height: calc(0.65 * (100vh - 56px));">
            <div class="px-1 pb-1" style="position:absolute; background-color: black; color: white; z-index: 10;">Connectivity Wheel</div>
            <connectivity :connections="connections" :region-names="region_names"></connectivity>
          </div>
          <div class="col-12" style="height: calc(0.33 * (100vh - 56px));">
            <div class="px-1 pb-1" style="position:absolute; background-color: black; color: white; z-index: 10;">Region Timeseries</div>
            <timeseries :connections="connections" :region-timeseries="timeseries" :region-names="region_names"></timeseries>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="row no-gutters">
          <div class="col-12">
            <div class="px-1 pb-1" style="position:absolute; background-color: black; color: white; z-index: 10;">Region Table</div>
            <b-table></b-table>
          </div>
          <div class="col-12">
            <div class="px-1 pb-1" style="position:absolute; background-color: black; color: white; z-index: 10;">Connection Table</div>
            <b-table></b-table>
          </div>
          <div class="col-12">
            <div class="px-1 pb-1" style="position:absolute; background-color: black; color: white; z-index: 10;">Metadata</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const loader = window.httpVueLoader;

    var app = new Vue({
      el: '#app',
      components: {
        'ortho': loader('components/ortho/ortho.vue'),
        'connectivity': loader('components/connectivity.vue'),
        'timeseries': loader('components/timeseries.vue')
      },
      data: {
        timeseries: [],
        connectivity: [],
        regions: [],
        region_names: [],

        threshold: 282,
        file: null
      },
      computed: {
        connections() {
          let connections = [];
          for (let i = 0; i < this.connectivity.length; i++){
            for (let j = i + 1; j < this.connectivity.length; j++) {
              if (this.connectivity[i][j] !== 0) {
                connections.push({ region1: i, region2: j, strength: this.connectivity[i][j] });     
              }
            }
          }

          let keep = Math.floor(connections.length * this.computedThreshold);

          return connections.sort((a, b) => b.strength - a.strength).slice(0, keep);
        },
        computedThreshold() {
          //  y = 7.627206e-26 - (-0.006862342/-6.916626)*(1 - e^(+6.916626*x))
          //  y = 0.01 - (-0.005945409/-7.07209)*(1 - e^(+7.07209*x))
          //  y = 0.01 - (-0.07737624/-3.939799)*(1 - e^(+3.939799*x))
          let y = 0.01 - (-0.07737624/-3.939799)*(1 - Math.exp(+3.939799*(this.threshold / 1000)));
          console.log(this.threshold);
          return y;
          // return this.threshold / 100;
        }
      },
      methods: {
        thresholdXfromY(y) {
          //  y = 0.01 - (-0.07737624/-3.939799)*(1 - e^(+3.939799*x))
          let x = Math.log(-(-3.939799*y - 0.03797825) / 0.07737624) / 3.939799;
          return x * 1000;
        },
        load(file) {
          fetch(file)
            .then(res => res.json())
            .then(data => {
              this.timeseries = data.timeseries;
              this.connectivity = data.connectivity;
              this.regions = data.regions;
              this.region_names = data.region_names;
              this.threshold = this.thresholdXfromY(data.threshold);
            });
        }
      },
      created() {
        this.load('data/harvard.json');
      },
      watch: {}
    })
  </script>

</body>

<style>
.nav-params {
  width: 300px;
}
</style>
</html>

